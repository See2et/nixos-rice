#!/usr/bin/env bash

set -u

event="${1:-event}"
message="${2:-OpenCode event}"
powershell_exe="/mnt/c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe"

if [[ ! -x "$powershell_exe" ]]; then
  exit 0
fi

export OPENCODE_NOTIFY_TITLE="OpenCode (${event})"
export OPENCODE_NOTIFY_MESSAGE="$message"

"$powershell_exe" -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command '
try {
  [Windows.UI.Notifications.ToastNotificationManager,Windows.UI.Notifications,ContentType=WindowsRuntime] > $null
  $template = [Windows.UI.Notifications.ToastNotificationManager]::GetTemplateContent([Windows.UI.Notifications.ToastTemplateType]::ToastText02)
  $xml = [xml]$template.GetXml()
  ($xml.toast.visual.binding.text | Where-Object { $_.id -eq "1" }).AppendChild($xml.CreateTextNode($env:OPENCODE_NOTIFY_TITLE)) > $null
  ($xml.toast.visual.binding.text | Where-Object { $_.id -eq "2" }).AppendChild($xml.CreateTextNode($env:OPENCODE_NOTIFY_MESSAGE)) > $null
  $doc = New-Object Windows.Data.Xml.Dom.XmlDocument
  $doc.LoadXml($xml.OuterXml)
  $toast = [Windows.UI.Notifications.ToastNotification]::new($doc)
  $toast.ExpirationTime = [DateTimeOffset]::Now.AddMinutes(1)
  [Windows.UI.Notifications.ToastNotificationManager]::CreateToastNotifier("PowerShell").Show($toast)
} catch {
  exit 0
}
' >/dev/null 2>&1 || true
